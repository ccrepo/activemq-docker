#!/bin/bash

display_error_text() {
  if [[ "$#" != "1" ]]
  then 
    echo "unknown error"
    return 1
  fi
  case ${1} in 
  1)
  echo "too many args error"
  ;;
  2)
  echo "invalid argument error"
  ;;
  3)
  echo "variable not set"
  ;;
  *)
  echo "error number ${1}"
  ;;
  esac
  return 0
}

check_arg() {
  if [[ "$#" != "1" ]]
  then 
    return 1
  fi
  COUNT=`echo "${1}" | grep ' ' | wc -l | awk '{$1=$1; print}' `

  if [[ "$COUNT" != "0" ]]
  then 
    return 2
  fi
  return 0
}

check_var() {
  if [[ "$#" != "1" ]]
  then 
    return 1
  fi
  VALUE="${!1}"
  TRIMMED="`echo "${VALUE}" | awk '{$1=$1; print}'`"
  if [[ "${TRIMMED}" == "" ]]
  then
    return 3
  fi
  echo "env ${1} = ${VALUE}"
  return 0
}

stop_container() {
  check_arg $@
  RESULT=$?
  if [[ "${RESULT}" != '0' ]]
  then 
    echo RESULT "${RESULT}"
    return ${RESULT}
  fi
  docker stop "${1}" 2>/dev/null
  return $?
}

remove_container() {
  check_arg $@
  RESULT=$?
  if [[ "${RESULT}" != '0' ]]
  then 
    echo RESULT "${RESULT}"
    return ${RESULT}
  fi
  docker rm "${1}" 2>/dev/null
  return $?
}

remove_image() {
  check_arg $@
  RESULT=$?
  if [[ "${RESULT}" != '0' ]]
  then 
    echo RESULT "${RESULT}"
    return ${RESULT}
  fi
  docker rmi -f "${1}" 2>/dev/null
  return $?
}

if [[ ! -f ./environment ]]
then
  echo "environment file missing"
  exit 1
fi

if [[ ! -r ./environment ]]
then
  echo "environment file not readable"
  exit 1
fi

. ./environment

if [[ $# -gt 1 ]]
then
  echo "too many params"
  exit 1
fi

if [[ "${1}" != "dev" ]]
then
  echo "first parameter must be 'dev' to indicate build type."
  exit 1
fi

for i in BUILD_DIR \
TAG_ORG \
TAG_SERVER \
TAG_ID_SERVER \
ACTIVEMQ_DOCKER_GIT_SERVER \
TAG_CLIENT \
TAG_ID_CLIENT \
ACTIVEMQ_DOCKER_GIT_CLIENT \
TAG_CONSUMER \
TAG_ID_CONSUMER \
ACTIVEMQ_DOCKER_GIT_CONSUMER \
ACTIVEMQ_DOCKER_GIT_USER \
ACTIVEMQ_DOCKER_GIT_PASSWORD \
ACTIVEMQ_DOCKER_BUILD \
ACTIVEMQ_DOCKER_ACTIVEMQ_SHA512 \
ACTIVEMQ_DOCKER_ACTIVEMQ_PACKAGENAME \
ACTIVEMQ_DOCKER_ACTIVEMQ_DOWNLOAD \
ACTIVEMQ_DOCKER_GRADLE_PACKAGENAME \
ACTIVEMQ_DOCKER_GRADLE_DOWNLOAD \
ACTIVEMQ_DOCKER_SERVER_HOSTNAME \
ACTIVEMQ_DOCKER_USER_NAME \
ACTIVEMQ_DOCKER_USER_PASSWORD \
YAML
do
  #echo "checking '${i}' = '${!i}'"
  check_var "${i}"
  RESULT=$?
  if [[ "${RESULT}" != "0" ]]
  then 
    display_error_text "${RESULT}"
    exit 1
  fi
done

if [[ "${BUILD_DIR}" == "" ]]
then
  echo "\$BUILD_DIR not set"
  exit 1
fi

#DOCKER_FILTER="${TAG_PREFIX_SERVER}|${TAG_PREFIX_CLIENT}|${TAG_PREFIX_CONSUMER}"
DOCKER_FILTER="${TAG_PREFIX_ACTIVESERVER}"

for i in ` (docker ps 2>&1) | grep -v 'CONTAINER ID' | \
  egrep "${DOCKER_FILTER}" | cut -d' ' -f1`
do
  echo "stop container $i"
  stop_container $i
  RESULT=$?
  if [[ "${RESULT}" != "0" ]]
  then 
    display_error_text "${RESULT}"
    exit 1
  fi
done

for i in ` (docker ps --all 2>&1) | grep -v 'CONTAINER ID' | \
  egrep "${DOCKER_FILTER}" | cut -d' ' -f1`
do
  echo "remove container $i"
  remove_container $i
  RESULT=$?
  if [[ "${RESULT}" != "0" ]]
  then 
    display_error_text "${RESULT}"
    exit 1
  fi
done

for i in ` (docker images -a 2>&1) | grep -v 'REPOSITORY' | \
  egrep "${DOCKER_FILTER}" | awk '{ print $2 }' `
do
  echo "remove image '$i'"
  remove_image $i
  RESULT=$?
  if [[ "${RESULT}" != "0" ]]
  then 
    display_error_text "${RESULT}"
    exit 1
  fi
done

for i in ` (docker ps --all 2>&1) | grep -v 'CONTAINER ID' | \
  egrep "${DOCKER_FILTER}" | cut -d' ' -f1`
do
  echo "failed container still exists ${i}"
  exit 1
done

for i in ` (docker images -a 2>&1) | grep -v 'REPOSITORY' | \
  egrep "${DOCKER_FILTER}" | awk '{ print $3 }' `
do
  echo "failed image still exists ${i}"
  exit 1
done

cd ..

if [[ -d "$BUILD_DIR"  ]]
then
  rm -fr "$BUILD_DIR" 2>/dev/null
fi

if [[ -d "$BUILD_DIR"  ]]
then
  echo "dir '$BUILD_DIR' could not be deleted"
  exit 1
fi

mkdir -p "$BUILD_DIR"

if [[ ! -d "$BUILD_DIR" ]]
then
  echo "dir '$BUILD_DIR' could not be created"
  exit 1
fi

if [[ ! -f "${YAML}" ]]
then
  echo "file '${YAML}' is missing "
  exit 1
fi

cp -ip "./artefact/sh/startup.sh" "./build/startup.sh" && chmod 555 "./build/startup.sh"
if [[ "$?" != "0" ]]
then
  echo "cp of startup.sh to build dir failed."
  exit 1
fi 

cp -ip "./artefact/pub/authorized_keys" "./build/authorized_keys" && chmod 555 "./build/authorized_keys"
if [[ "$?" != "0" ]]
then
  echo "cp of authorized_keys to build dir failed."
  exit 1
fi 

( docker compose -p ${TAG_ORG} -f "${YAML}" build ) && \
( docker compose -p ${TAG_ORG} -f "${YAML}" up -d )

docker ps --all

rm -fr "./build/*"

docker exec -it "${TAG_ORG}" bash

